<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Universal Master Planner V1.6 (Reset Fixed)</title>

  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>

  <style>
    :root {
      /* Light Mode Variables */
      --primary: #2563eb; --accent: #f59e0b; 
      --bg: #f8fafc; --card-bg: #ffffff;
      --text: #1e293b; --text-sub: #64748b;
      --line: #e2e8f0; --input-bg: #ffffff;
      --success: #16a34a; --danger: #ef4444;
      --header-bg: rgba(255,255,255,0.95);
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --radius: 16px;
    }

    /* Dark Mode Variables */
    [data-theme="dark"] {
      --primary: #3b82f6; --accent: #fbbf24;
      --bg: #0f172a; --card-bg: #1e293b;
      --text: #f1f5f9; --text-sub: #94a3b8;
      --line: #334155; --input-bg: #020617;
      --success: #22c55e; --danger: #f87171;
      --header-bg: rgba(30, 41, 59, 0.95);
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.3), 0 2px 4px -1px rgba(0,0,0,0.2);
    }

    * { box-sizing: border-box; }
    body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; line-height: 1.6; transition: background 0.3s, color 0.3s; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px 20px 100px 20px; }
    
    /* Error Screen */
    #error-screen {
      position: fixed; inset: 0; background: var(--bg); z-index: 9999;
      display: none; flex-direction: column; align-items: center; justify-content: center;
      padding: 20px; text-align: center; color: var(--danger);
    }
    
    /* ìœ í‹¸ë¦¬í‹° */
    .hidden { display: none !important; }
    .flex-center { display: flex; align-items: center; justify-content: center; }
    .flex-between { display: flex; align-items: center; justify-content: space-between; }
    
    .btn { cursor: pointer; border: none; border-radius: 6px; font-weight: 700; transition: 0.2s; padding: 6px 12px; font-size: 0.85rem;}
    .btn:hover { opacity: 0.8; transform: translateY(-1px); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-outline { background: var(--card-bg); border: 1px solid var(--line); color: var(--text); }
    .btn-icon { background: transparent; padding: 4px; font-size: 1.1rem; color: var(--text-sub); }
    .btn-icon:hover { color: var(--primary); background: rgba(128,128,128,0.1); border-radius: 4px; }
    .btn-danger:hover { color: var(--danger); background: rgba(239, 68, 68, 0.1); }

    /* ì¢Œì¸¡ ìƒë‹¨ ë„êµ¬ (ë‹¤í¬ëª¨ë“œ ë²„íŠ¼ ë“±) */
    .left-tools {
      position: absolute; top: 0; left: 0;
      display: flex; gap: 8px; z-index: 10;
    }

    /* D-Day */
    .dday-wrapper {
      position: absolute; top: 0; right: 0;
      display: flex; flex-direction: column; gap: 6px; align-items: flex-end;
      z-index: 10;
    }
    .dday-badge {
      background: #1e293b; color: white; padding: 6px 12px; border-radius: 20px;
      font-size: 0.85rem; font-weight: 700; box-shadow: var(--shadow);
      cursor: pointer; transition: 0.2s; display: flex; gap: 8px; align-items: center;
    }
    .dday-badge:hover { transform: translateY(-2px); background: var(--primary); }
    .dday-count { color: var(--accent); font-weight: 800; }

    /* í—¤ë” & í†µê³„ */
    .sticky-header {
      position: sticky; top: 10px; z-index: 100;
      background: var(--header-bg); backdrop-filter: blur(8px);
      border: 1px solid var(--line); border-radius: var(--radius);
      padding: 12px 20px; margin-bottom: 24px; box-shadow: var(--shadow);
      display: flex; gap: 15px; flex-wrap: wrap; align-items: center;
    }
    .prog-wrap { flex: 1; min-width: 200px; }
    .prog-bar { height: 10px; background: var(--line); border-radius: 99px; overflow: hidden; margin-bottom: 4px;}
    .prog-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.3s ease; }
    .prog-text { font-size: 0.85rem; color: var(--text-sub); font-weight: 600; display: flex; justify-content: space-between; }
    
    /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
    .card {
      background: var(--card-bg); border-radius: var(--radius); border: 1px solid var(--line);
      padding: 20px; box-shadow: var(--shadow); position: relative;
      display: flex; flex-direction: column; transition: transform 0.2s, box-shadow 0.2s;
    }
    .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; min-height: 32px; }
    .card-actions { display: flex; gap: 2px; opacity: 0; transition: opacity 0.2s; }
    .card:hover .card-actions { opacity: 1; }
    .badge { background: rgba(37, 99, 235, 0.1); color: var(--primary); padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 800; }
    h3 { margin: 0 0 5px 0; font-size: 1.25rem; color: var(--text); display:flex; align-items:center; gap:8px; }
    .editable:hover { text-decoration: underline; text-decoration-style: dashed; text-underline-offset: 4px; cursor: pointer; color: var(--primary); }

    /* ì„œë¸Œ ì²´í¬ë¦¬ìŠ¤íŠ¸ */
    .sub-list {
      margin-top: 15px; padding-top: 10px; border-top: 1px dashed var(--line);
      font-size: 0.9rem; color: var(--text-sub);
    }
    .sub-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    .sub-item input { accent-color: var(--success); cursor: pointer; transform: scale(1.1); }
    .sub-item span { cursor: pointer; transition:0.2s; }
    .sub-item span:hover { color: var(--primary); text-decoration: underline; }
    
    /* íƒ€ì´ë¨¸ */
    .timer-box {
      margin-top: auto; padding-top: 12px; border-top: 1px solid var(--line);
      display: flex; justify-content: space-between; align-items: center;
    }
    .timer-display { font-family: 'Courier New', monospace; font-weight: 800; font-size: 1.1rem; color: var(--text); min-width:90px; text-align:center;}
    .chk-wrap { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 0.9rem; color: var(--text-sub); cursor: pointer; }
    .chk-wrap input { width: 18px; height: 18px; accent-color: var(--success); cursor: pointer; }

    /* ê³ ìŠ¤íŠ¸ ì¹´ë“œ */
    .ghost-card {
      border: 2px dashed var(--line); background: transparent; box-shadow: none;
      min-height: 150px; cursor: pointer; color: var(--text-sub); transition: 0.2s;
    }
    .ghost-card:hover { border-color: var(--primary); color: var(--primary); background: rgba(37, 99, 235, 0.05); }
    .ghost-plus { font-size: 2.5rem; margin-bottom: 10px; }

    /* ë…¸íŠ¸ ì˜ì—­ */
    .note-area-wrap { margin-top: 15px; border-top: 1px dashed var(--line); padding-top: 10px; }
    .note-label-small { font-size: 0.8rem; font-weight: 700; color: var(--text-sub); margin-bottom: 4px; display: block; }
    .note-view {
      min-height: 60px; padding: 10px; border-radius: 8px; cursor: pointer;
      font-size: 0.95rem; color: var(--text); border: 1px solid transparent; background: rgba(128,128,128,0.05);
    }
    .note-view:hover { background: rgba(128,128,128,0.1); outline: 1px dashed var(--line); }
    .note-view[data-empty="true"]::before { content: "í´ë¦­í•˜ì—¬ ë…¸íŠ¸/ì˜¤ë‹µ ë©”ëª¨ ì‘ì„± (Markdown)"; color: var(--text-sub); font-size: 0.9rem; }
    .note-edit { display: none; width: 100%; margin-top: 5px; }
    .note-textarea {
      width: 100%; min-height: 100px; padding: 12px; border: 1px solid var(--line); border-radius: 8px;
      font-family: 'Consolas', monospace; resize: vertical; background: var(--input-bg); color: var(--text); line-height: 1.5;
    }
    .md-content h1, .md-content h2 { border-bottom: 1px solid var(--line); padding-bottom: 5px; font-size: 1.2em; margin-top: 0;}
    .md-content p { margin: 0.5em 0; }
    .katex { font-size: 1.1em; }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 999;
      display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px);
    }
    .modal { background: var(--card-bg); padding: 24px; border-radius: 20px; width: 400px; max-width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); border: 1px solid var(--line); }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 700; font-size: 0.9rem; color: var(--text); }
    .form-group input, .form-group textarea, .form-group select { 
      width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 8px; 
      font-family: inherit; background: var(--input-bg); color: var(--text);
    }
    
    .highlighted { animation: highlight 1.5s ease-out; }
    @keyframes highlight { 
      0% { box-shadow: 0 0 0 0 rgba(37,99,235,0.4); border-color:var(--primary); } 
      50% { box-shadow: 0 0 0 6px rgba(37,99,235,0.2); } 
      100% { box-shadow: 0 0 0 0 rgba(37,99,235,0); } 
    }

    /* íƒ­ ë²„íŠ¼ */
    .tabs { display: flex; gap: 8px; overflow-x: auto; margin-bottom: 20px; padding-bottom: 5px; flex-wrap: wrap; }
    .tab-btn { 
      flex: 0 0 auto; padding: 8px 16px; 
      border-radius: 20px; border: 1px solid var(--line); 
      background: var(--card-bg); color: var(--text-sub); font-weight: 700; cursor:pointer; transition:0.2s;
    }
    .tab-btn:hover { border-color: var(--primary); color: var(--primary); }
    .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

  </style>
</head>
<body>

<div id="error-screen">
  <h2 style="font-size:2rem; margin-bottom:10px;">ğŸš¨ ë°ì´í„° ì˜¤ë¥˜ ë°œìƒ</h2>
  <p>ë¶ˆëŸ¬ì˜¨ ë°ì´í„°(JSON)ì— ë¬¸ì œê°€ ìˆê±°ë‚˜, êµ¬ì¡°ê°€ ë§ì§€ ì•Šì•„ ì•±ì„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
  <p id="err-msg" style="background:var(--line); padding:10px; border-radius:8px; font-family:monospace; margin:20px 0; color:var(--text)"></p>
  <button class="btn btn-danger" style="padding:15px 30px; font-size:1.2rem;" onclick="hardReset()">âš¡ ë°ì´í„° ê°•ì œ ì´ˆê¸°í™” (ë³µêµ¬)</button>
</div>

<div id="app" class="container"></div>

<div id="editModal" class="modal-overlay">
  <div class="modal">
    <h2 id="modalTitle">í¸ì§‘</h2>
    <div class="form-group">
      <label id="lblTitle">ì œëª©</label>
      <input type="text" id="editTitle">
    </div>
    <div class="form-group">
      <label id="lblDesc">ë‚´ìš©</label>
      <textarea id="editDesc" rows="3"></textarea>
    </div>
    <div class="form-group" id="grpQBox">
      <label>í•µì‹¬ í¬ì¸íŠ¸ / íŒ (Markdown)</label>
      <textarea id="editQBox" rows="2" style="background:var(--input-bg); font-size:0.9rem;"></textarea>
    </div>
    <div class="form-group" id="grpBadge">
      <label>ë°°ì§€/íƒœê·¸</label>
      <input type="text" id="editBadge">
    </div>
    <div style="display:flex; justify-content:flex-end; gap:10px;">
      <button class="btn btn-outline" onclick="closeModal()">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveCardChange()">ì €ì¥</button>
    </div>
  </div>
</div>

<div id="ddayModal" class="modal-overlay">
  <div class="modal">
    <h2>ğŸ“† D-Day ì„¤ì • (ìµœëŒ€ 3ê°œ)</h2>
    <div id="ddayInputs"></div>
    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
      <button class="btn btn-outline" onclick="document.getElementById('ddayModal').style.display='none'">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveDDays()">ì €ì¥</button>
    </div>
  </div>
</div>

<div id="moveModal" class="modal-overlay">
  <div class="modal">
    <h2 id="moveModalTitle">ğŸ“‚ ì´ë™í•  ìœ„ì¹˜ ì„ íƒ</h2>
    
    <div class="form-group">
      <label>1. ê³¼ëª©(Subject) ì„ íƒ</label>
      <select id="moveSubject" onchange="updateMoveUI_Topics()"></select>
    </div>

    <div class="form-group" id="grpMoveTopic">
      <label>2. ì£¼ì œ(Topic) ì„ íƒ</label>
      <select id="moveTopic" onchange="updateMoveUI_Tabs()"></select>
    </div>

    <div class="form-group" id="grpMoveTab">
      <label>3. íƒ­(Tab) ì„ íƒ</label>
      <select id="moveTab"></select>
    </div>

    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
      <button class="btn btn-outline" onclick="document.getElementById('moveModal').style.display='none'">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="execMoveCard()">ì´ë™</button>
    </div>
  </div>
</div>

<input type="file" id="fileInput" accept=".json" style="display:none" onchange="loadJsonFile(event)">

<script>
let DATA = null;
const STORAGE_KEY = 'universal_planner_v9_data';
const THEME_KEY = 'universal_planner_theme';
const APP = document.getElementById('app');
const ERR_SCREEN = document.getElementById('error-screen');

// [Safety: Global Error Handler]
window.onerror = function(msg, url, line) {
  showErrorScreen(`Script Error: ${msg} (Line ${line})`);
  return true; 
};

function showErrorScreen(msg) {
  APP.style.display = 'none';
  ERR_SCREEN.style.display = 'flex';
  document.getElementById('err-msg').innerText = msg;
}

// [FIX 6: Robust Reset]
window.hardReset = async function() {
  if(confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)')) {
    // 1. Storage Clear
    localStorage.removeItem(STORAGE_KEY);
    
    // 2. Memory Reset (Factory Default)
    DATA = {
      meta: { appTitle: "CPA Master Planner V9", version: "9.0" },
      home: { title: "2026 CPA í•©ê²© í”Œë˜ë„ˆ", subtitle: "ê³¼ëª©ë³„ ì§„ë„ì™€ ì‹œê°„ì„ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•˜ì„¸ìš”", subjects: [], dDays:[{label:"1ì°¨ ì‹œí—˜", date:"2026-02-28"}] },
      details: {},
      modules: {}
    };

    // 3. Try to fetch default template if available (Simulate fresh start)
    try {
      const res = await fetch('cpa_content_v2.json');
      if(res.ok) { 
         const json = await res.json(); 
         DATA = {...DATA, ...json}; 
      }
    } catch (e) { console.log('Default content fetch skipped'); }

    // 4. Save & Render (Ensures UI updates even if reload fails)
    saveData();
    renderRouter();
    
    // 5. Reload (Cleaner)
    location.reload();
  }
}
window.resetData = window.hardReset;

// [Core Helpers]
function renderStickyHeader(label, pct, time) {
  return `
    <div class="sticky-header">
      <div class="prog-wrap">
        <div class="prog-text"><span>${label}</span><span style="color:var(--primary)">${pct||0}%</span></div>
        <div class="prog-bar"><div class="prog-fill" style="width:${pct||0}%"></div></div>
      </div>
      <div style="background:#1e293b; color:white; padding:6px 12px; border-radius:99px; font-family:monospace; font-weight:700;">
        â± ${time || "00:00:00"}
      </div>
    </div>
  `;
}

// [FIX 3: Advanced Scroll Logic]
function renderRouter(keepScroll = false) { 
  router(keepScroll); 
}

// Badge parsing
function badgeTags(raw){
  const s = (raw ?? '').toString().trim();
  if(!s) return [];
  return s.split(',').map(x => x.trim()).filter(Boolean);
}

function applyMath() {
  if (window.renderMathInElement) {
    try {
      sanitizeLatexInElement(document.body);
      renderMathInElement(document.body, {
        delimiters: [{left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false}],
        throwOnError: false
      });
    } catch(e) { console.warn('MathJax error', e); }
  }
}

function sanitizeLatexInElement(root) {
  if (!root) return;
  const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
  let node;
  while ((node = walker.nextNode())) {
    const parent = node.parentElement;
    if (!parent) continue;
    const tag = parent.tagName;
    if (tag === 'SCRIPT' || tag === 'STYLE' || tag === 'TEXTAREA' || tag === 'CODE' || tag === 'PRE') {
      continue;
    }
    if (node.nodeValue && node.nodeValue.includes('$') && (node.nodeValue.includes('%') || node.nodeValue.includes('&'))) {
      const sanitized = sanitizeLatexString(node.nodeValue);
      if (sanitized !== node.nodeValue) node.nodeValue = sanitized;
    }
  }
}

function sanitizeLatexString(text) {
  let out = '';
  let i = 0;
  let inMath = false;
  let delimiter = '';

  while (i < text.length) {
    const ch = text[i];
    if (!inMath) {
      if (ch === '$' && !isEscaped(text, i)) {
        if (text[i + 1] === '$') {
          inMath = true;
          delimiter = '$$';
          out += '$$';
          i += 2;
          continue;
        }
        inMath = true;
        delimiter = '$';
        out += '$';
        i += 1;
        continue;
      }
      out += ch;
      i += 1;
      continue;
    }

    if (delimiter === '$$' && ch === '$' && text[i + 1] === '$' && !isEscaped(text, i)) {
      inMath = false;
      out += '$$';
      i += 2;
      continue;
    }
    if (delimiter === '$' && ch === '$' && !isEscaped(text, i)) {
      inMath = false;
      out += '$';
      i += 1;
      continue;
    }

    if (ch === '%' && text[i - 1] !== '\\') {
      out += '\\%';
      i += 1;
      continue;
    }
    if (ch === '&' && text[i - 1] !== '\\') {
      out += '\\&';
      i += 1;
      continue;
    }

    out += ch;
    i += 1;
  }

  return out;
}

function isEscaped(text, index) {
  let count = 0;
  let i = index - 1;
  while (i >= 0 && text[i] === '\\') {
    count += 1;
    i -= 1;
  }
  return count % 2 === 1;
}

// [Deep Clone & ID Regeneration]
function deepCloneAndRegenerateIds(data, type) {
  const clone = JSON.parse(JSON.stringify(data));
  if (type === 'subject') {
      const oldId = clone.id;
      const newId = 'subj_' + Date.now() + Math.random().toString(36).substr(2,5);
      clone.id = newId; clone.time = 0;
      if(DATA.details[oldId]) {
          const newDetail = JSON.parse(JSON.stringify(DATA.details[oldId]));
          newDetail.id = newId; 
          newDetail.cards = newDetail.cards.map(c => deepCloneAndRegenerateIds(c, 'detail_card'));
          DATA.details[newId] = newDetail;
      }
      return clone;
  }
  if (type === 'detail_card') {
      clone.id = 'card_' + Date.now() + Math.random().toString(36).substr(2,5);
      clone.time = 0; clone.done = false;
      if(clone.module && DATA.modules[clone.module]) {
          const oldModId = clone.module;
          const newModId = 'mod_' + Date.now() + Math.random().toString(36).substr(2,5);
          clone.module = newModId;
          const newMod = JSON.parse(JSON.stringify(DATA.modules[oldModId]));
          newMod.id = newModId;
          newMod.tabs.forEach(t => { t.questions = t.questions.map(q => deepCloneAndRegenerateIds(q, 'question')); });
          DATA.modules[newModId] = newMod;
      }
      return clone;
  }
  if (type === 'question') {
      clone.id = 'q_' + Date.now() + Math.random().toString(36).substr(2,5);
      clone.done = false; clone.time = 0; clone.isRunning = false; clone.userNote = ""; 
      return clone;
  }
  return clone;
}

// [Init]
async function init() {
  // Theme Init
  initDarkMode();

  const localData = localStorage.getItem(STORAGE_KEY);
  if (localData) {
    try {
      DATA = JSON.parse(localData);
      if(!DATA.home || !DATA.details || !DATA.modules) throw new Error("Invalid Data Structure");
    } catch (e) {
      showErrorScreen("ì €ì¥ëœ ë°ì´í„° ì†ìƒ: " + e.message);
      return;
    }
  } else {
    DATA = {
      meta: { appTitle: "CPA Master Planner V9", version: "9.0" },
      home: { title: "2026 CPA í•©ê²© í”Œë˜ë„ˆ", subtitle: "ê³¼ëª©ë³„ ì§„ë„ì™€ ì‹œê°„ì„ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•˜ì„¸ìš”", subjects: [], dDays:[{label:"1ì°¨ ì‹œí—˜", date:"2026-02-28"}] },
      details: {},
      modules: {}
    };
    try {
      const res = await fetch('cpa_content_v2.json');
      if(res.ok) { const json = await res.json(); DATA = {...DATA, ...json}; }
    } catch (e) {}
    saveData();
  }
  
  if(!DATA.home.dDays) DATA.home.dDays = [];

  if(window.marked) marked.setOptions({ breaks: true });
  window.addEventListener('hashchange', () => router(false));
  
  try {
    router(false);
    setInterval(tickTimers, 1000);
  } catch(e) {
    showErrorScreen("ë Œë”ë§ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
  }
}

// [Dark Mode Logic]
function initDarkMode() {
  const savedTheme = localStorage.getItem(THEME_KEY);
  if (savedTheme === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
  }
}
function toggleDarkMode() {
  const current = document.documentElement.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem(THEME_KEY, next);
}

function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(DATA)); }

window.exportData = function() {
  const dataStr = JSON.stringify(DATA, null, 2);
  const blob = new Blob([dataStr], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `planner_backup_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

window.triggerImport = function() { document.getElementById('fileInput').click(); }

window.loadJsonFile = function(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const json = JSON.parse(e.target.result);
      if(!json.home || !json.details) throw new Error("í•„ìˆ˜ ë°ì´í„°(home, details)ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
      if (confirm(`"${file.name}" íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        DATA = json;
        if(!DATA.home.dDays) DATA.home.dDays = [];
        saveData();
        renderRouter();
        alert("ì„±ê³µì ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤!");
      }
    } catch (err) {
      alert("íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n" + err.message);
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// [Routing]
function getRoute() {
  const hash = window.location.hash || '#/';
  const [path, query] = hash.replace(/^#/, '').split('?');
  const parts = path.split('/').filter(Boolean);
  const params = new URLSearchParams(query);
  return { page: parts[0] || 'home', id: parts[1], focus: params.get('focus') };
}

// [CRITICAL FIX: Scroll Jumping Prevention]
function router(keepScroll = false) {
  const route = getRoute();
  const savedScroll = window.scrollY; // 1. Save Position

  // [Safety Net] Force Body Height to prevent collapse
  if (keepScroll) {
    document.body.style.minHeight = document.body.scrollHeight + 'px';
  }

  try {
    if (route.page === 'detail' && route.id && !DATA.details[route.id]) {
        DATA.details[route.id] = { id: route.id, title: "ìƒˆ ê³¼ëª© ìƒì„¸", subtitle: "í† í”½ì„ ì¶”ê°€í•˜ì„¸ìš”", filters: [], cards: [] };
    }
    if (route.page === 'module' && route.id && !DATA.modules[route.id]) {
        DATA.modules[route.id] = { id: route.id, title: "ìƒˆ í•™ìŠµ ëª¨ë“ˆ", subtitle: "ì´ë¡  ë° ë¬¸ì œë¥¼ ì¶”ê°€í•˜ì„¸ìš”", backTo: "#/", tabs: [{ id: "tab1", label: "ê¸°ë³¸ ì´ë¡ ", theoryNote: "", questions: [] }] };
    }

    if (route.page === 'home') renderHome();
    else if (route.page === 'detail') renderDetail(route.id);
    else if (route.page === 'module') renderModule(route.id);
    
    // 2. Restore logic with delay to ensure DOM paint
    setTimeout(() => {
        applyMath();
        if (route.focus) {
            const el = document.getElementById(`card-${route.focus}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.classList.add('highlighted');
                setTimeout(() => el.classList.remove('highlighted'), 1500);
            }
            document.body.style.minHeight = ''; // Release height
        } else if (keepScroll) {
            window.scrollTo(0, savedScroll); // 3. Restore Forcefully
            setTimeout(() => { document.body.style.minHeight = ''; }, 50); // Release height after stable
        } else {
            window.scrollTo(0, 0);
            document.body.style.minHeight = '';
        }
    }, 50);
  } catch(e) {
      showErrorScreen("í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨: " + e.message);
      document.body.style.minHeight = '';
  }
}

// [Renderers]
function renderHome() {
  const totalStats = calcTotalStats();
  const ddays = DATA.home.dDays || [];
  const ddayHtml = ddays.map(d => {
    if(!d.date) return '';
    const target = new Date(d.date).setHours(0,0,0,0);
    const today = new Date().setHours(0,0,0,0);
    const diff = (target - today) / (1000 * 60 * 60 * 24);
    let dLabel = diff > 0 ? `D-${Math.ceil(diff)}` : (diff === 0 ? "D-Day" : `D+${Math.abs(Math.ceil(diff))}`);
    return `<div class="dday-badge" onclick="openDDayModal()"><span>${d.label}</span><span class="dday-count">${dLabel}</span></div>`;
  }).join('');

  APP.innerHTML = `
    <header style="text-align:center; margin-bottom:30px; position:relative; padding-top:20px;">
      <div class="left-tools">
        <button class="btn btn-outline" style="border-radius:20px;" onclick="toggleDarkMode()" title="ë‹¤í¬ëª¨ë“œ í† ê¸€">ğŸŒ™/â˜€ï¸</button>
      </div>
      <div class="dday-wrapper">
        ${ddayHtml}
        ${ddays.length === 0 ? '<div class="dday-badge" style="background:#eee; color:#aaa" onclick="openDDayModal()">+ D-Day ì¶”ê°€</div>' : ''}
      </div>
      <h1 class="editable" onclick="openEditModal('app_info', 'home')" title="ì œëª© ìˆ˜ì •">${DATA.home.title}</h1>
      <p class="editable" onclick="openEditModal('app_info', 'home')" style="color:var(--text-sub)">${DATA.home.subtitle}</p>
      <div style="margin-top:10px; display:flex; gap:8px; justify-content:center;">
        <button class="btn btn-outline" style="font-size:0.8rem;" onclick="triggerImport()">ğŸ“‚ ë°±ì—… ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="btn btn-outline" style="font-size:0.8rem;" onclick="exportData()">ğŸ’¾ ë°±ì—… ì €ì¥</button>
        <button class="btn btn-outline" style="font-size:0.8rem; color:#ef4444; border-color:#ef4444;" onclick="hardReset()">ğŸ—‘ ì´ˆê¸°í™”</button>
      </div>
    </header>

    ${renderStickyHeader('ì „ì²´ ì§„í–‰ë¥ ', totalStats.pct, totalStats.timeStr)}

    <div class="grid" id="homeGrid">
      ${DATA.home.subjects.map((sub, idx) => {
         const detailStats = calcSubjectStats(sub.id); 
         const detailCards = DATA.details[sub.id] ? DATA.details[sub.id].cards : [];
         
         return `
        <div class="card" draggable="true" data-index="${idx}">
          <div class="card-top">
             <div style="display:flex; gap:6px;">
               <span class="badge">${sub.badge}</span>
             </div>
             <div class="card-actions">
               <button class="btn btn-icon" title="ê³¼ëª© ë³µì œ" onclick="duplicateCard('subject', null, ${idx});event.stopPropagation()">ğŸ“‘</button>
               <button class="btn btn-icon" title="ë§í¬ ë³µì‚¬" onclick="copyLink('subject','${sub.id}','${sub.name}');event.stopPropagation()">ğŸ”—</button>
               <button class="btn btn-icon" title="ê³¼ëª© ìˆ˜ì •" onclick="openEditModal('subject', 'home', ${idx});event.stopPropagation()">âœï¸</button>
               <button class="btn btn-icon btn-danger" title="ê³¼ëª© ì‚­ì œ" onclick="deleteCard('subject', 'home', ${idx});event.stopPropagation()">ğŸ—‘</button>
             </div>
          </div>
          <h3 style="cursor:pointer;" onclick="location.hash='#/detail/${sub.id}'" title="í´ë¦­í•˜ì—¬ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™">${sub.name}</h3>
          <p style="color:var(--text-sub); font-size:0.9rem;">${sub.examInfo}</p>
          
          <div class="sub-list">
             ${detailCards.map((c, cIdx) => {
               const cStats = calcCardStats(c);
               const isDone = cStats.isComplete;
               return `
               <div class="sub-item">
                  <input type="checkbox" ${isDone ? 'checked' : ''} onchange="toggleDetailCardStatus('${sub.id}', ${cIdx}, this.checked)"> 
                  <span onclick="location.hash='#/detail/${sub.id}?focus=${c.id}'" style="${isDone?'text-decoration:line-through; color:var(--text-sub)':''}" title="í´ë¦­í•˜ì—¬ í•´ë‹¹ ì¹´ë“œë¡œ ì´ë™">${c.title}</span>
               </div>
               `;
             }).join('')}
             ${detailCards.length===0 ? '<span style="font-size:0.8rem; color:#ccc;">(í† í”½ ì—†ìŒ)</span>' : ''}
          </div>
          
          <div class="timer-box" onclick="event.stopPropagation()">
             <label class="chk-wrap">
                <input type="checkbox" onchange="toggleCheckAll('subject', '${sub.id}', this.checked)" ${detailStats.pct===100?'checked':''}>
                <span>${detailStats.pct===100 ? 'ì™„ë£Œ' : 'ì „ì²´'}</span>
             </label>
             <div class="flex-center" style="gap:5px;">
                <button class="btn btn-icon" title="ì‹œê°„ ì§ì ‘ ìˆ˜ì •" onclick="editTime('subject', null, ${idx}, null)">âœï¸</button>
                <div class="timer-display" id="time-disp-subject-${sub.id}">${detailStats.timeStr}</div>
                <button class="btn btn-outline" style="padding:2px 8px; width:40px; ${sub.isRunning?'color:red; border-color:red;':''}" 
                  onclick="toggleTimer('subject', null, ${idx}, null)">
                  ${sub.isRunning ? 'âšâš' : 'â–¶'}
                </button>
             </div>
          </div>
        </div>
      `}).join('')}
      <div class="card ghost-card flex-center" style="flex-direction:column;" onclick="openAddModal('subject', 'home')">
        <div class="ghost-plus">+</div><div>ìƒˆ ê³¼ëª© ì¶”ê°€</div>
      </div>
    </div>
  `;
  setupDragDrop('home');
}

function renderDetail(sid) {
  const detail = DATA.details[sid];
  const stats = calcSubjectStats(sid);
  const seen = new Set();
  const badgeList = [];
  let hasNone = false;
  (detail.cards || []).forEach(c => {
    const tags = badgeTags(c.badge);
    if (tags.length === 0) { hasNone = true; return; }
    tags.forEach(t => { if (!seen.has(t)) { seen.add(t); badgeList.push(t); } });
  });

  const filters = [{ key: 'all', label: 'ì „ì²´ë³´ê¸°' }, ...badgeList.map(b => ({ key: b, label: b })), ...(hasNone ? [{ key: '__none__', label: 'ë¯¸ë¶„ë¥˜' }] : [])];

  APP.innerHTML = `
    <div style="margin-bottom:20px;"><button class="btn btn-outline" onclick="location.hash='#/'">â† í™ˆìœ¼ë¡œ</button></div>
    <div style="margin-bottom:20px;">
      <h1 class="editable" onclick="openEditModal('page_info', 'detail', null, null, '${sid}')">${detail.title}</h1>
      <p class="editable" onclick="openEditModal('page_info', 'detail', null, null, '${sid}')" style="color:var(--text-sub);">${detail.subtitle}</p>
    </div>

    ${renderStickyHeader('ê³¼ëª© ì§„í–‰ë¥ ', stats.pct, stats.timeStr)}

    <div class="tabs">
      ${filters.map(f => `<button class="tab-btn ${f.key==='all'?'active':''}" onclick='filterCards(${JSON.stringify(f.key)}, this)'>${f.label}</button>`).join('')}
    </div>

    <div class="grid" id="cardGrid">
      ${detail.cards.map((c, i) => renderCardItem(c, 'detail', sid, i)).join('')}
      <div class="card ghost-card flex-center" style="flex-direction:column;" onclick="openAddModal('detail', '${sid}')">
        <div class="ghost-plus">+</div><div>ìƒˆ ì¹´ë“œ ì¶”ê°€</div>
      </div>
    </div>
  `;
  setupDragDrop('detail', sid);
}

function renderModule(mid) {
  const mod = DATA.modules[mid];
  const activeTabId = mod.activeTab || (mod.tabs[0] ? mod.tabs[0].id : null);
  const activeTab = mod.tabs.find(t => t.id === activeTabId) || mod.tabs[0];
  const stats = calcModuleStats(mid);
  if(!activeTab.theoryNote) activeTab.theoryNote = "";
  
  const theoryId = `theory-${mid}-${activeTabId}`;

  APP.innerHTML = `
    <div class="flex-between" style="margin-bottom:20px;">
      <button class="btn btn-outline" onclick="location.hash='${mod.backTo}'">â† ë’¤ë¡œ</button>
      <div style="display:flex; gap:10px;">
        <button class="btn btn-primary" onclick="exportAnki('${mid}')">ğŸ“¥ Anki CSV</button>
        <button class="btn btn-outline" onclick="location.hash='#/'">ğŸ  í™ˆ</button>
      </div>
    </div>

    <h1 class="editable" onclick="openEditModal('page_info', 'module', null, null, '${mid}')">${mod.title}</h1>
    <p class="editable" onclick="openEditModal('page_info', 'module', null, null, '${mid}')" style="color:var(--text-sub); margin-bottom:20px;">${mod.subtitle}</p>

    ${renderStickyHeader('ëª¨ë“ˆ ì§„í–‰ë¥ ', stats.pct, stats.timeStr)}

    <div class="tabs">
      ${mod.tabs.map(t => `<button class="tab-btn ${t.id===activeTabId?'active':''}" onclick="switchTab('${mid}', '${t.id}')">${t.label}</button>`).join('')}
      <button class="tab-btn" onclick="openAddModal('tab_add', '${mid}')">+ íƒ­ ì¶”ê°€</button>
    </div>

    <div class="card theory-card" id="card-${theoryId}" style="margin-bottom:30px;">
      <div class="card-top">
        <h3 class="editable" onclick="openEditModal('tab_rename', '${mid}', null, '${activeTabId}')">
           ğŸ“Œ ${activeTab.label}
        </h3>
        <div class="card-actions" style="opacity:1;">
           <button class="btn btn-icon" title="ë§í¬ ë³µì‚¬" onclick="copyLink('module','${theoryId}','${activeTab.label}',{pid:'${mid}'})">ğŸ”—</button>
           <button class="btn btn-icon" title="ë‚´ìš© ìˆ˜ì •" onclick="toggleNoteView('theory-${activeTabId}')">âœï¸</button>
           <button class="btn btn-icon btn-danger" title="íƒ­ ì‚­ì œ" onclick="deleteTab('${mid}', '${activeTabId}')">ğŸ—‘</button>
        </div>
      </div>
      
      <div id="view-theory-${activeTabId}" class="note-view md-content" 
           data-empty="${!activeTab.theoryNote}" 
           onclick="toggleNoteView('theory-${activeTabId}')">
           ${marked.parse(activeTab.theoryNote || "")}
      </div>
      <div id="edit-theory-${activeTabId}" class="note-edit">
        <textarea id="ta-theory-${activeTabId}" class="note-textarea" placeholder="# ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...">${activeTab.theoryNote}</textarea>
        <div style="text-align:right; margin-top:5px;">
           <button class="btn btn-primary" onclick="saveNoteText('theory', '${mid}', null, '${activeTabId}', 'theory-${activeTabId}')">ì €ì¥</button>
        </div>
      </div>

      <div class="timer-box" onclick="event.stopPropagation()">
         <label class="chk-wrap">
           <input type="checkbox" ${activeTab.done ? 'checked' : ''} onchange="toggleCheck(this, 'theory', '${mid}', 0, '${activeTabId}')">
           <span>ì´ë¡  í•™ìŠµ ì™„ë£Œ</span>
         </label>
         <div class="flex-center" style="gap:5px;">
            <button class="btn btn-icon" title="ì‹œê°„ ìˆ˜ì •" onclick="editTime('theory', '${mid}', 0, '${activeTabId}')">âœï¸</button>
            <div class="timer-display" id="time-disp-theory-${mid}-${activeTabId}">${formatTime(activeTab.time || 0)}</div>
            <button class="btn btn-outline" style="padding:2px 8px; width:40px; ${activeTab.isRunning?'color:red; border-color:red;':''}" 
              onclick="toggleTimer('theory', '${mid}', 0, '${activeTabId}')">
              ${activeTab.isRunning ? 'âšâš' : 'â–¶'}
            </button>
         </div>
      </div>
    </div>

    <div class="grid" id="questionGrid">
      ${activeTab.questions.map((q, i) => renderCardItem(q, 'module', mid, i, activeTabId)).join('')}
      <div class="card ghost-card flex-center" style="flex-direction:column;" onclick="openAddModal('module', '${mid}', '${activeTabId}')">
        <div class="ghost-plus">+</div><div>ìƒˆ ë¬¸ì œ ì¶”ê°€</div>
      </div>
    </div>
  `;
  setupDragDrop('module', mid, activeTabId);
}

function renderCardItem(item, level, pid, idx, tabId = null) {
  const isMod = level === 'module';
  const stableId = item.id || (level + '-' + pid + '-' + idx);
  const userNote = item.userNote || "";
  
  let subItemsHtml = '';
  let isDone = item.done;
  let totalTime = item.time || 0;

  if (!isMod && item.module && DATA.modules[item.module]) {
    const mStats = calcModuleStats(item.module);
    const moduleTime = mStats.total > 0 ? mStats.rawTime : 0;
    totalTime = (item.time || 0) + moduleTime; 
    if (mStats.total > 0) { isDone = mStats.isComplete; } else { isDone = item.done; }
    
    const modTabs = DATA.modules[item.module].tabs;
    subItemsHtml = `<div class="sub-list">`;
    modTabs.forEach(t => {
      subItemsHtml += `<div class="sub-item"><input type="checkbox" ${t.done?'checked':''} onchange="toggleSubItem('${item.module}', 'theory', '${t.id}', null, this.checked)"> <span>${t.label} (ì´ë¡ )</span></div>`;
      t.questions.forEach((q, qIdx) => {
         const qLabel = q.src || (q.text.length > 15 ? q.text.substring(0,15)+'...' : q.text);
         subItemsHtml += `<div class="sub-item">
            <input type="checkbox" ${q.done?'checked':''} onchange="toggleSubItem('${item.module}', 'question', '${t.id}', ${qIdx}, this.checked)"> 
            <span onclick="location.hash='#/module/${item.module}?focus=${q.id}'; event.stopPropagation();" title="í´ë¦­í•˜ì—¬ ëª¨ë“ˆë¡œ ì´ë™">${qLabel}</span>
         </div>`;
      });
    });
    subItemsHtml += `</div>`;
  }

  let linkLabel = item.title;
  if (isMod) linkLabel = item.src ? item.src : (item.text.length>20 ? item.text.substring(0,20)+'...' : item.text);

  return `
    <div class="card ${!isMod && item.module ? 'clickable' : ''}" draggable="true" data-index="${idx}" id="card-${stableId}">
      <div class="card-top">
        <div style="display:flex; align-items:center;">
           <span class="card-handle material-icons" style="cursor:grab; color:#cbd5e1; margin-right:5px;">â ¿</span>
           <span class="badge">${isMod ? (item.src || 'ë¬¸í•­') : (item.badge || 'Topic')}</span>
        </div>
        <div class="card-actions">
           ${!isMod && item.module ? `<button class="btn btn-icon" title="ëª¨ë“ˆ ë°”ë¡œê°€ê¸°" onclick="location.hash='#/module/${item.module}'; event.stopPropagation();">ğŸš€</button>` : ''}
           <button class="btn btn-icon" title="ë³µì œ" onclick="duplicateCard('${level}', '${pid}', ${idx}, '${tabId||''}');event.stopPropagation()">ğŸ“‘</button>
           <button class="btn btn-icon" title="ì´ë™" onclick="moveCard('${level}', '${pid}', ${idx}, '${tabId||''}');event.stopPropagation()">ğŸ“‚</button>
           <button class="btn btn-icon" title="ë§í¬ ë³µì‚¬" onclick="copyLink('${level}','${stableId}','${linkLabel.replace(/'/g,"")}',{pid:'${pid}',module:'${item.module||''}'});event.stopPropagation()">ğŸ”—</button>
           <button class="btn btn-icon" title="ìˆ˜ì •" onclick="openEditModal('${level}', '${pid}', ${idx}, '${tabId || ''}');event.stopPropagation()">âœï¸</button>
           <button class="btn btn-icon btn-danger" title="ì‚­ì œ" onclick="deleteCard('${level}', '${pid}', ${idx}, '${tabId || ''}');event.stopPropagation()">ğŸ—‘</button>
        </div>
      </div>

      <div onclick="${!isMod && item.module ? `location.hash='#/module/${item.module}'` : ''}">
        ${isMod 
          ? `<div class="md-content" style="font-weight:600; font-size:1.05rem; margin-bottom:10px;">${marked.parse(item.text)}</div>`
          : `<h3>${item.title}</h3><p>${item.scope || ''}</p>`
        }
        ${item.qbox ? `<div class="md-content" style="background:var(--bg); padding:10px; border-radius:8px; font-size:0.9rem; margin-top:10px; color:var(--text-sub);">ğŸ’¡ ${marked.parse(item.qbox)}</div>` : ''}
      </div>

      ${!isMod ? subItemsHtml : ''}

      ${isMod ? `
        <div class="note-area-wrap">
          <span class="note-label-small">ğŸ“ ì˜¤ë‹µ/í•„ê¸° ë…¸íŠ¸ (í´ë¦­í•˜ì—¬ ìˆ˜ì •)</span>
          <div id="view-${stableId}" class="note-view md-content" 
               data-empty="${!userNote}" 
               onclick="toggleNoteView('${stableId}')">
               ${marked.parse(userNote)}
          </div>
          <div id="edit-${stableId}" class="note-edit">
             <textarea id="ta-${stableId}" class="note-textarea" placeholder="í’€ì´ ì‘ì„±...">${userNote}</textarea>
             <div style="text-align:right; margin-top:5px;">
               <button class="btn btn-primary" onclick="saveNoteText('card', '${pid}', ${idx}, '${tabId}', '${stableId}')">ì €ì¥</button>
             </div>
          </div>
        </div>
      ` : ''}

      <div class="timer-box" onclick="event.stopPropagation()">
         <label class="chk-wrap">
           <input type="checkbox" ${isDone ? 'checked' : ''} onchange="toggleCheck(this, '${level}', '${pid}', ${idx}, '${tabId || ''}')">
           <span>ì™„ë£Œ</span>
         </label>
         <div class="flex-center" style="gap:5px;">
            <button class="btn btn-icon" title="ì‹œê°„ ìˆ˜ì •" onclick="editTime('${level}', '${pid}', ${idx}, '${tabId||''}')">âœï¸</button>
            <div class="timer-display" id="time-disp-${stableId}">${formatTime(totalTime)}</div>
            <button class="btn btn-outline" style="padding:2px 8px; width:40px; ${item.isRunning?'color:red; border-color:red;':''}" 
              onclick="toggleTimer('${level}', '${pid}', ${idx}, '${tabId||''}')">
              ${item.isRunning ? 'âšâš' : 'â–¶'}
            </button>
         </div>
      </div>
    </div>
  `;
}

// [Logic]
function formatTime(s) {
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  const sc = s % 60;
  return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(sc).padStart(2, '0')}`;
}

// [FIX 5: Logic Order Corrected]
function toggleDetailCardStatus(pid, idx, status) {
  if(!DATA.details[pid]) return;
  const card = DATA.details[pid].cards[idx];
  
  // 1. Update Card Status
  card.done = status;
  if(status) card.isRunning = false; 

  // 2. Propagate to Module (MUST BE DONE BEFORE CHECKING STATS)
  if(card.module && DATA.modules[card.module]) {
    const mod = DATA.modules[card.module];
    mod.tabs.forEach(t => {
      t.done = status;
      t.questions.forEach(q => q.done = status);
    });
  }

  // 3. Check Subject Stats (Now module stats are correct)
  if (status) {
     const stats = calcSubjectStats(pid);
     if (stats.pct === 100) {
         const subj = DATA.home.subjects.find(s => s.id === pid);
         if(subj) subj.isRunning = false; // Stop Subject Timer
     }
  }

  saveData(); renderRouter(true);
}

function calcCardStats(card) {
  let ownTime = card.time || 0;
  if (card.module && DATA.modules[card.module]) {
    const mStats = calcModuleStats(card.module);
    return { isComplete: mStats.isComplete, time: ownTime + mStats.rawTime };
  }
  return { isComplete: card.done, time: ownTime };
}

function calcModuleStats(mid) {
  let total=0, done=0, time=0;
  if(DATA.modules && DATA.modules[mid]) {
    DATA.modules[mid].tabs.forEach(t => {
      total++; if(t.done) done++; time += (t.time || 0);
      t.questions.forEach(q => {
        total++; if(q.done) done++; time += (q.time||0);
      });
    });
  }
  return { pct: total?Math.round((done/total)*100):0, timeStr: formatTime(time), rawTime: time, isComplete: (total>0 && total===done), total };
}

function calcSubjectStats(sid) {
  let ownTime = 0;
  const subj = DATA.home.subjects.find(s => s.id === sid);
  if (subj) ownTime = subj.time || 0;

  if (!DATA.details[sid]) return { pct: 0, timeStr: formatTime(ownTime), rawTime: ownTime };
  
  const cards = DATA.details[sid].cards;
  let detailTime = 0;
  let doneCount = 0;
  cards.forEach(c => {
    const cStat = calcCardStats(c);
    detailTime += cStat.time;
    if(cStat.isComplete) doneCount++;
  });
  
  const totalTime = ownTime + detailTime;
  return { 
    pct: cards.length ? Math.round((doneCount/cards.length)*100) : 0, 
    timeStr: formatTime(totalTime), 
    rawTime: totalTime 
  };
}

function calcTotalStats() { 
  let t=0, d=0;
  let totalTime = 0;
  DATA.home.subjects.forEach(sub => {
    const stats = calcSubjectStats(sub.id);
    totalTime += stats.rawTime;
  });
  if(DATA.details) Object.values(DATA.details).forEach(x=>{
    t += x.cards.length; 
    x.cards.forEach(c => { if(calcCardStats(c).isComplete) d++; });
  }); 
  return {pct: t?Math.round((d/t)*100):0, timeStr: formatTime(totalTime)}; 
}

// [FIX 4: Auto Stop on All Checks] for sub-items
function toggleSubItem(mid, type, tid, qIdx, checked) {
  if (!DATA.modules[mid]) return;
  const tab = DATA.modules[mid].tabs.find(t => t.id === tid);
  if (!tab) return;
  
  if (type === 'theory') {
      tab.done = checked;
      if(checked) tab.isRunning = false; // Stop timer
  } else if (type === 'question') {
      tab.questions[qIdx].done = checked;
      if(checked) tab.questions[qIdx].isRunning = false; // Stop timer
  }

  // [NEW] Logic: If Module is 100%, Stop Parent Card Timer. 
  if (checked) {
      const mStats = calcModuleStats(mid);
      if (mStats.pct === 100) {
          // Reverse Lookup to find Parent Card
          Object.keys(DATA.details).forEach(did => {
             const detail = DATA.details[did];
             detail.cards.forEach(c => {
                 if(c.module === mid) {
                     if(c.isRunning) c.isRunning = false; // Stop Card Timer
                     // Check Subject Completion (Chain Reaction)
                     const sStats = calcSubjectStats(did);
                     if(sStats.pct === 100) {
                         const subj = DATA.home.subjects.find(s=>s.id === did);
                         if(subj) subj.isRunning = false; // Stop Subject Timer
                     }
                 }
             });
          });
      }
  }

  saveData(); renderRouter(true);
}

function setAllChildStatus(level, pid, idx, status) {
  if (level === 'subject') {
    if(DATA.details[pid]) DATA.details[pid].cards.forEach((card, i) => setAllChildStatus('detail', pid, i, status));
  } else if (level === 'detail') {
    const card = DATA.details[pid].cards[idx];
    card.done = status;
    if(status) card.isRunning = false; // Stop timer
    if (card.module && DATA.modules[card.module]) {
      const mod = DATA.modules[card.module];
      mod.tabs.forEach(t => { 
          t.done = status; 
          if(status) t.isRunning = false; 
          t.questions.forEach(q => { 
              q.done = status; 
              if(status) q.isRunning = false; 
          }); 
      });
    }
  }
}

// [FIXED] Updated to stop Subject Timer
function toggleCheckAll(level, pid, checked) {
  setAllChildStatus(level, pid, null, checked);
  // [NEW] If subject 'done' is checked, stop the subject timer too.
  if(level === 'subject' && checked) {
      const subj = DATA.home.subjects.find(s => s.id === pid);
      if(subj) subj.isRunning = false;
  }
  saveData(); renderRouter(true);
}

// [FIX 1: Timer Stop on Check] for generic checks
function toggleCheck(chk, lvl, pid, idx, tid) {
  const status = chk.checked;
  if(lvl==='detail') { toggleDetailCardStatus(pid, idx, status); }
  else if(lvl==='theory') {
      const item = DATA.modules[pid].tabs.find(t=>t.id===tid);
      item.done = status;
      if(status) item.isRunning = false;
  }
  else {
      const item = DATA.modules[pid].tabs.find(t=>t.id===tid).questions[idx];
      item.done = status;
      if(status) item.isRunning = false;
  }
  saveData(); renderRouter(true);
}

function toggleTimer(lvl, pid, idx, tid) {
  let item;
  if(lvl==='subject') item = DATA.home.subjects[idx];
  else if(lvl==='theory') item = DATA.modules[pid].tabs.find(t=>t.id===tid);
  else if(lvl==='detail') item = DATA.details[pid].cards[idx];
  else item = DATA.modules[pid].tabs.find(t=>t.id===tid).questions[idx];
  item.isRunning = !item.isRunning; saveData(); renderRouter(true);
}

function editTime(lvl, pid, idx, tid) {
  let item;
  if(lvl==='subject') item = DATA.home.subjects[idx];
  else if(lvl==='theory') item = DATA.modules[pid].tabs.find(t=>t.id===tid);
  else if(lvl==='detail') item = DATA.details[pid].cards[idx];
  else item = DATA.modules[pid].tabs.find(t=>t.id===tid).questions[idx];
  const minStr = prompt("ìˆ˜ì •í•  ì‹œê°„ì„ ë¶„(minute) ë‹¨ìœ„ë¡œ ì…ë ¥í•˜ì„¸ìš”:", Math.floor((item.time||0)/60));
  if(minStr === null) return;
  const min = parseInt(minStr);
  if(!isNaN(min)) { item.time = min * 60; saveData(); renderRouter(true); }
}

function tickTimers() {
  let chg = false;
  const run = (obj) => { if(obj.isRunning){ obj.time=(obj.time||0)+1; chg=true; }};
  if(!DATA) return;
  if(DATA.home.subjects) DATA.home.subjects.forEach(s => run(s));
  if(DATA.details) Object.values(DATA.details).forEach(d => d.cards.forEach(c => run(c)));
  if(DATA.modules) Object.values(DATA.modules).forEach(m => m.tabs.forEach(t => { run(t); t.questions.forEach(q => run(q)); }));
  if(chg) { saveData(); updateTimerDOM(); }
}

function updateTimerDOM() {
  const update = (id, val) => { const el=document.getElementById(id); if(el) el.innerText=formatTime(val); };
  DATA.home.subjects.forEach(s => update(`time-disp-subject-${s.id}`, calcSubjectStats(s.id).rawTime));
  Object.keys(DATA.modules).forEach(mid => {
    DATA.modules[mid].tabs.forEach(t => {
      update(`time-disp-theory-${mid}-${t.id}`, t.time||0);
      t.questions.forEach((q,i) => update(`time-disp-${q.id||('module-'+mid+'-'+i)}`, q.time||0));
    });
  });
  Object.keys(DATA.details).forEach(did => {
     DATA.details[did].cards.forEach((c,i) => update(`time-disp-${c.id||('detail-'+did+'-'+i)}`, calcCardStats(c).time));
  });
}

function toggleNoteView(uniqueId) {
  const view = document.getElementById(`view-${uniqueId}`);
  const edit = document.getElementById(`edit-${uniqueId}`);
  const ta = document.getElementById(`ta-${uniqueId}`);
  if (edit.style.display === 'none' || edit.style.display === '') {
    view.style.display = 'none'; edit.style.display = 'block'; if(ta) ta.focus();
  } else { edit.style.display = 'none'; view.style.display = 'block'; }
}

function saveNoteText(type, pid, idx, tabId, domId) {
  const text = document.getElementById(`ta-${domId}`).value;
  if(type === 'theory') { DATA.modules[pid].tabs.find(t=>t.id===tabId).theoryNote = text; saveData(); renderModule(pid); } 
  else { 
    DATA.modules[pid].tabs.find(t=>t.id===tabId).questions[idx].userNote = text; 
    const view = document.getElementById(`view-${domId}`); 
    view.innerHTML = marked.parse(text); view.setAttribute('data-empty', !text);
    toggleNoteView(domId); applyMath(); saveData(); 
  }
}

function openAddModal(mode, pid, tabId) { openEditModal(mode, pid, undefined, tabId); }
let editState = null; 
function openEditModal(mode, pid, idx, tabId, pageId) {
  editState = { mode, pid, idx, tabId, pageId };
  document.getElementById('editModal').style.display = 'flex';
  document.getElementById('grpBadge').style.display = 'block';
  document.getElementById('grpQBox').style.display = 'none';
  const title = document.getElementById('editTitle');
  const desc = document.getElementById('editDesc');
  const badge = document.getElementById('editBadge');
  const qbox = document.getElementById('editQBox');
  if (mode === 'subject' && idx !== undefined) { const i = DATA.home.subjects[idx]; title.value=i.name; desc.value=i.examInfo; badge.value=i.badge; }
  else if (mode === 'subject') { title.value=""; desc.value=""; badge.value="New"; }
  else if (mode === 'app_info') { title.value=DATA.home.title; desc.value=DATA.home.subtitle; document.getElementById('grpBadge').style.display='none'; }
  else if (mode === 'page_info') { const d = pageId in DATA.details ? DATA.details[pageId] : DATA.modules[pageId]; title.value=d.title; desc.value=d.subtitle; document.getElementById('grpBadge').style.display='none'; }
  else if (mode === 'tab_rename') { title.value=DATA.modules[pid].tabs.find(x=>x.id===tabId).label; desc.parentElement.style.display='none'; document.getElementById('grpBadge').style.display='none'; }
  else if (mode === 'tab_add') { title.value=""; desc.parentElement.style.display='none'; document.getElementById('grpBadge').style.display='none'; }
  else if (mode === 'detail') { 
    document.getElementById('grpQBox').style.display = 'block';
    if(idx!==undefined) { const c=DATA.details[pid].cards[idx]; title.value=c.title; desc.value=c.scope; badge.value=c.badge; qbox.value=c.qbox || ""; } 
    else { title.value=""; desc.value=""; badge.value="Topic"; qbox.value=""; }
  } else if (mode === 'module') {
    if(idx!==undefined) { const q=DATA.modules[pid].tabs.find(x=>x.id===tabId).questions[idx]; title.value=q.text; desc.value=q.src; document.getElementById('grpBadge').style.display='none'; }
    else { title.value=""; desc.value=""; document.getElementById('grpBadge').style.display='none'; }
  }
}
function closeModal() { document.getElementById('editModal').style.display='none'; document.getElementById('editDesc').parentElement.style.display='block'; }
function saveCardChange() {
  const t = document.getElementById('editTitle').value;
  const d = document.getElementById('editDesc').value;
  const b = document.getElementById('editBadge').value;
  const q = document.getElementById('editQBox').value;
  const { mode, pid, idx, tabId, pageId } = editState;
  if (mode === 'app_info') { DATA.home.title = t; DATA.home.subtitle = d; }
  else if (mode === 'page_info') { if(DATA.details[pageId]) { DATA.details[pageId].title = t; DATA.details[pageId].subtitle = d; } else { DATA.modules[pageId].title = t; DATA.modules[pageId].subtitle = d; } }
  else if (mode === 'tab_rename') { DATA.modules[pid].tabs.find(x=>x.id===tabId).label = t; }
  else if (mode === 'tab_add') { DATA.modules[pid].tabs.push({id: Date.now().toString(), label: t, theoryNote:"", questions:[]}); }
  else if (mode === 'subject') {
    if (idx === undefined) { const nid='s_'+Date.now(); DATA.home.subjects.push({ id: nid, name: t, examInfo: d, badge: b }); DATA.details[nid]={id:nid, title:t+" ìƒì„¸", subtitle:"", cards:[]}; }
    else { const s=DATA.home.subjects[idx]; s.name=t; s.examInfo=d; s.badge=b; }
  } else if (mode === 'detail') {
    const list = DATA.details[pid].cards;
    if (idx === undefined) { const mid='m_'+Date.now(); list.push({id:Date.now().toString(), title:t, scope:d, badge:b, qbox:q, module:mid, category:'all'}); DATA.modules[mid]={id:mid, title:t, subtitle:d, backTo:`#/detail/${pid}`, tabs:[{id:'t1', label:'ê¸°ë³¸', questions:[]}]}; } 
    else { list[idx].title=t; list[idx].scope=d; list[idx].badge=b; list[idx].qbox=q; }
  } else if (mode === 'module') {
    const list = DATA.modules[pid].tabs.find(x=>x.id===tabId).questions;
    if (idx === undefined) list.push({id:Date.now().toString(), text:t, src:d}); else { list[idx].text=t; list[idx].src=d; }
  }
  saveData(); closeModal(); renderRouter(true);
}
function deleteCard(mode, pid, idx, tabId) { if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (í•˜ìœ„ ë°ì´í„°ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤)')) {
  if (mode === 'subject') { const s = DATA.home.subjects[idx]; const d = DATA.details[s.id]; if(d) { d.cards.forEach(c => { if(c.module) delete DATA.modules[c.module]; }); delete DATA.details[s.id]; } DATA.home.subjects.splice(idx, 1); }
  else if (mode === 'detail') { const c = DATA.details[pid].cards[idx]; if(c.module) delete DATA.modules[c.module]; DATA.details[pid].cards.splice(idx, 1); }
  else if (mode === 'module') { DATA.modules[pid].tabs.find(x => x.id === tabId).questions.splice(idx, 1); }
  saveData(); renderRouter(true);
}}
function deleteTab(mid, tid) { if(confirm('íƒ­ ì‚­ì œ?')) { const t=DATA.modules[mid].tabs; if(t.length>1) t.splice(t.findIndex(x=>x.id===tid),1); saveData(); renderModule(mid); }}

// [D-Day Logic]
function openDDayModal() {
  const div = document.getElementById('ddayInputs');
  div.innerHTML = '';
  const ddays = DATA.home.dDays || [];
  for(let i=0; i<3; i++) {
    const d = ddays[i] || {label:'', date:''};
    div.innerHTML += `
      <div style="display:flex; gap:5px; margin-bottom:10px;">
        <input type="text" placeholder="ì‹œí—˜/ëª©í‘œëª…" value="${d.label}" id="ddL_${i}" style="flex:1;">
        <input type="date" value="${d.date}" id="ddD_${i}">
      </div>`;
  }
  document.getElementById('ddayModal').style.display='flex';
}
function saveDDays() {
  const newDays = [];
  for(let i=0; i<3; i++) {
    const l = document.getElementById(`ddL_${i}`).value;
    const d = document.getElementById(`ddD_${i}`).value;
    if(l && d) newDays.push({label:l, date:d});
  }
  DATA.home.dDays = newDays;
  saveData();
  document.getElementById('ddayModal').style.display='none';
  renderRouter(true);
}

function copyLink(type, id, title, extra) {
  let link = '';
  if (type === 'subject') link = `#/detail/${id}`;
  else if (type === 'detail') link = extra && extra.module ? `#/module/${extra.module}` : `#/detail/${extra.pid}?focus=${id}`;
  else if (type === 'module') link = `#/module/${extra.pid}?focus=${id}`;
  navigator.clipboard.writeText(`[${title}](${link})`).then(() => alert(`ë§í¬ ë³µì‚¬ë¨:\n[${title}]`));
}
function setupDragDrop(lvl, pid, tid) {
  const grid = document.getElementById(lvl==='home'?'homeGrid':(lvl==='detail'?'cardGrid':'questionGrid'));
  let srcIdx = null;
  grid.querySelectorAll('.card[draggable="true"]').forEach(el => {
    el.addEventListener('dragstart', e => { srcIdx=+el.dataset.index; el.classList.add('dragging'); });
    el.addEventListener('dragend', e => el.classList.remove('dragging'));
    el.addEventListener('dragover', e => e.preventDefault());
    el.addEventListener('drop', e => {
      e.stopPropagation(); const tgtIdx=+el.dataset.index;
      if(srcIdx!==tgtIdx && srcIdx!==null) {
        let list;
        if(lvl==='home') list=DATA.home.subjects;
        else if(lvl==='detail') list=DATA.details[pid].cards;
        else list=DATA.modules[pid].tabs.find(t=>t.id===tid).questions;
        const [m] = list.splice(srcIdx, 1); list.splice(tgtIdx, 0, m);
        saveData(); renderRouter(true);
      }
    });
  });
}
function exportAnki(mid) {
  let csv = "Front,Back,Tags\n";
  DATA.modules[mid].tabs.forEach(t => t.questions.forEach(q => csv += `"${q.text.replace(/"/g,'""')}","${(q.userNote||"").replace(/"/g,'""')}","${mid}"\n`));
  const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})); a.download=`${mid}.csv`; a.click();
}
function filterCards(k, btn) {
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
  const cards = DATA.details[getRoute().id].cards;
  cards.forEach((c, i) => {
    const el = document.getElementById(`card-${c.id||('detail-'+getRoute().id+'-'+i)}`);
    if(el) el.style.display = (k==='all' || c.category===k) ? 'flex' : 'none';
  });
}
function switchTab(mid, tid) { DATA.modules[mid].activeTab = tid; saveData(); renderModule(mid); }

// [DUPLICATE & MOVE Implementation]
function duplicateCard(level, pid, idx, tabId) {
  if (level === 'subject') {
    const org = DATA.home.subjects[idx];
    const clone = deepCloneAndRegenerateIds(org, 'subject');
    DATA.home.subjects.splice(idx + 1, 0, clone);
  } 
  else if (level === 'detail') {
    const list = DATA.details[pid].cards;
    const clone = deepCloneAndRegenerateIds(list[idx], 'detail_card');
    list.splice(idx + 1, 0, clone);
  }
  else if (level === 'module') {
    const list = DATA.modules[pid].tabs.find(t => t.id === tabId).questions;
    const clone = deepCloneAndRegenerateIds(list[idx], 'question');
    list.splice(idx + 1, 0, clone);
  }
  saveData(); renderRouter(true);
}

let moveTarget = null;
function moveCard(level, pid, idx, tabId) {
  moveTarget = { level, pid, idx, tabId };
  
  const selSubject = document.getElementById('moveSubject');
  const grpTopic = document.getElementById('grpMoveTopic');
  const grpTab = document.getElementById('grpMoveTab');

  // Init UI
  selSubject.innerHTML = '';
  document.getElementById('moveTopic').innerHTML = '';
  document.getElementById('moveTab').innerHTML = '';
  
  DATA.home.subjects.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.innerText = s.name;
      selSubject.appendChild(opt);
  });

  if (level === 'detail') {
      document.getElementById('moveModalTitle').innerText = "ğŸ“‚ ì£¼ì œ ì¹´ë“œ ì´ë™ (ê³¼ëª© ì„ íƒ)";
      grpTopic.style.display = 'none';
      grpTab.style.display = 'none';
  } 
  else if (level === 'module') {
      document.getElementById('moveModalTitle').innerText = "ğŸ“‚ ë¬¸ì œ ì¹´ë“œ ì´ë™ (ìœ„ì¹˜ ì„ íƒ)";
      grpTopic.style.display = 'block';
      grpTab.style.display = 'block';
      updateMoveUI_Topics();
  }
  document.getElementById('moveModal').style.display='flex';
}

function updateMoveUI_Topics() {
    if(moveTarget.level !== 'module') return;
    const subId = document.getElementById('moveSubject').value;
    const selTopic = document.getElementById('moveTopic');
    selTopic.innerHTML = '';
    const detail = DATA.details[subId];
    if(detail && detail.cards.length > 0) {
        detail.cards.forEach((c, idx) => {
           if(c.module && DATA.modules[c.module]) {
               const opt = document.createElement('option');
               opt.value = c.module; 
               opt.innerText = c.title;
               selTopic.appendChild(opt);
           }
        });
    } else {
        const opt = document.createElement('option');
        opt.innerText = "(ì´ë™ ê°€ëŠ¥í•œ ì£¼ì œ ì—†ìŒ)";
        selTopic.appendChild(opt);
    }
    updateMoveUI_Tabs();
}

function updateMoveUI_Tabs() {
    if(moveTarget.level !== 'module') return;
    const mid = document.getElementById('moveTopic').value;
    const selTab = document.getElementById('moveTab');
    selTab.innerHTML = '';
    if(mid && DATA.modules[mid]) {
        DATA.modules[mid].tabs.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.id;
            opt.innerText = t.label;
            selTab.appendChild(opt);
        });
    } else {
         const opt = document.createElement('option');
         opt.innerText = "(íƒ­ ì—†ìŒ)";
         selTab.appendChild(opt);
    }
}

function execMoveCard() {
  const { level, pid, idx, tabId } = moveTarget;
  const targetSubId = document.getElementById('moveSubject').value;
  
  if (level === 'detail') {
      if (pid === targetSubId) { alert("í˜„ì¬ì™€ ë™ì¼í•œ ê³¼ëª©ì…ë‹ˆë‹¤."); return; }
      const card = DATA.details[pid].cards.splice(idx, 1)[0];
      if(!DATA.details[targetSubId]) DATA.details[targetSubId] = {id:targetSubId, title:"ìƒì„¸", cards:[]};
      DATA.details[targetSubId].cards.push(card);
      if(card.module && DATA.modules[card.module]) {
          DATA.modules[card.module].backTo = `#/detail/${targetSubId}`;
      }
  } 
  else if (level === 'module') {
      const targetMid = document.getElementById('moveTopic').value;
      const targetTid = document.getElementById('moveTab').value;
      if (!targetMid || !targetTid || !DATA.modules[targetMid]) {
          alert("ì´ë™í•  ëŒ€ìƒ(ì£¼ì œ/íƒ­)ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); return;
      }
      const srcList = DATA.modules[pid].tabs.find(t => t.id === tabId).questions;
      const [q] = srcList.splice(idx, 1);
      const dstList = DATA.modules[targetMid].tabs.find(t => t.id === targetTid).questions;
      dstList.push(q);
  }
  
  saveData();
  document.getElementById('moveModal').style.display='none';
  renderRouter(true);
}

init();
</script>
</body>
</html>
